# Описание проекта "Smart Home Control"

## 1. Обзор проекта

**Smart Home Control** — это мобильное приложение, разработанное на Flutter, предназначенное для управления устройствами умного дома, в частности, реле на базе микроконтроллера ESP8266. Приложение позволяет пользователям обнаруживать, добавлять и управлять релейными модулями в локальной сети, а также создавать и выполнять сценарии автоматизации.

**Основные технологии:**

*   **Фреймворк:** Flutter
*   **Язык программирования:** Dart
*   **Микроконтроллер:** ESP8266 (прошивка на C++/Arduino)
*   **Управление состоянием:** Provider
*   **HTTP-взаимодействие:** `http` пакет
*   **Обнаружение устройств:** `multicast_dns` (mDNS) и сканирование IP-диапазона
*   **Локальное хранение:** `shared_preferences`

## 2. Ключевые функции

### 2.1. Управление устройствами

*   **Добавление устройств:**
    *   **Автоматическое обнаружение:** Поиск устройств в локальной сети с использованием mDNS и сканирования IP-адресов.
    *   **Ручное добавление:** Возможность добавить устройство по его IP-адресу.
    *   **Проверка соединения:** Тестирование доступности устройства перед добавлением.
*   **Отображение списка устройств:** Наглядное представление всех добавленных устройств с их статусом.
*   **Обновление статуса:** Возможность обновить информацию о состоянии всех устройств или отдельного устройства.
*   **Удаление устройств:** Удаление устройств из списка.
*   **Информация об устройстве:** Отображение имени, IP-адреса, уровня сигнала Wi-Fi (RSSI) и количества активных реле.

### 2.2. Управление реле

*   **Переключение состояния:** Включение и выключение каждого реле на устройстве.
*   **Отображение состояния:** Индикация текущего состояния каждого реле (ВКЛ/ВЫКЛ).
*   **Переименование реле:** Возможность задавать пользовательские имена для каждого реле. Имена сохраняются на ESP8266 в EEPROM.

### 2.3. Управление сценариями

*   **Создание сценариев:** Пользователи могут создавать сценарии, состоящие из последовательности действий для различных устройств и их реле.
*   **Редактирование сценариев:** Изменение названия, описания, цвета, иконки, списка действий и статуса активности сценария.
*   **Действия в сценарии:**
    *   Выбор устройства и конкретного реле.
    *   Выбор действия: включить или выключить реле.
    *   Установка задержки перед выполнением следующего действия.
    *   Активация/деактивация отдельных действий в сценарии.
*   **Удаление сценариев:** Удаление ненужных сценариев.
*   **Активация/деактивация сценариев:** Включение или выключение сценария для выполнения.
*   **Визуализация:** Сценарии отображаются с выбранным цветом и иконкой для лучшей идентификации.

### 2.4. Выполнение сценариев

*   **Запуск сценариев:** Пользователи могут запускать активные сценарии.
*   **Лог выполнения:** После выполнения сценария доступен подробный лог с информацией о каждом шаге, успехе или ошибке.
*   **Параллельное и последовательное выполнение:** Приложение пытается отправить весь сценарий на ESP8266 для выполнения на стороне устройства. Если это не поддерживается или не удается, действия выполняются последовательно из приложения.

## 3. Структура проекта (ключевые компоненты)

### 3.1. Flutter-приложение (`lib/`)

*   **`main.dart`**:
    *   Точка входа в приложение.
    *   Инициализация провайдеров (`DeviceProvider`, `ScenarioProvider`).
    *   Настройка основной темы приложения (`ThemeData`), включая цветовые схемы, стили AppBar, карточек, кнопок и полей ввода.
    *   Установка `HomeScreen` в качестве начального экрана.

*   **`models/`**: Определяет структуры данных.
    *   **`relay_device.dart` (`RelayDevice`, `Relay`)**:
        *   `RelayDevice`: Представляет ESP8266 устройство с реле. Содержит имя, IP-адрес, уровень сигнала, список реле (`List<Relay>`) и необработанные JSON-данные с устройства. Включает методы для парсинга JSON, проверки поддержки сценариев устройством, статуса выполнения сценария и прогресса.
        *   `Relay`: Представляет отдельное реле на устройстве. Содержит ID, имя и текущее состояние (`isOn`).
    *   **`scenario.dart` (`Scenario`, `ScenarioAction`)**:
        *   `Scenario`: Представляет сценарий автоматизации. Содержит ID, имя, описание, список действий (`List<ScenarioAction>`), флаг активности, время последнего запуска, цвет и иконку.
        *   `ScenarioAction`: Представляет одно действие в сценарии. Содержит ID, IP-адрес и имя устройства, ID и имя реле, действие (включить/выключить), флаг активности и опциональную задержку.

*   **`providers/`**: Управляют состоянием приложения.
    *   **`device_provider.dart` (`DeviceProvider`)**:
        *   Отвечает за управление списком устройств (`List<RelayDevice>`).
        *   Функции: загрузка сохраненных IP-адресов устройств из `SharedPreferences`, сохранение IP-адресов, обновление статуса одного или всех устройств, переключение состояния реле, переименование реле, обнаружение устройств в сети (mDNS и сканирование IP), ручное добавление и удаление устройств.
        *   Взаимодействует с `RelayService` для выполнения сетевых операций.
    *   **`scenario_provider.dart` (`ScenarioProvider`)**:
        *   Отвечает за управление списком сценариев (`List<Scenario>`).
        *   Функции: загрузка и сохранение сценариев в `SharedPreferences` (в формате JSON), добавление, обновление и удаление сценариев, включение/выключение сценариев, выполнение сценариев (с логированием).
        *   Зависит от `DeviceProvider` для получения информации об устройствах при выполнении сценариев.
        *   Хранит лог последнего выполненного сценария.

*   **`services/`**: Содержат бизнес-логику и взаимодействие с внешними системами.
    *   **`relay_service.dart` (`RelayService`)**:
        *   Обеспечивает связь с устройствами ESP8266 по HTTP.
        *   Методы: `getStatus` (получение статуса устройства и его реле), `toggleRelay` (переключение реле), `toggleRelayToState` (установка реле в определенное состояние), `setRelayName` (изменение имени реле на устройстве), `pingDevice` (проверка доступности устройства), `discoverDevices` (комбинированный поиск через mDNS и сканирование IP), `addDeviceByIp` (добавление устройства по IP), `runScenarioOnDevice` (отправка набора действий на ESP для выполнения как сценария).
        *   Обрабатывает JSON-ответы от ESP8266, включая поддержку UTF-8 для имен реле.

*   **`screens/`**: UI-экраны приложения.
    *   **`home_screen.dart` (`HomeScreen`)**:
        *   Главный экран с двумя вкладками: "Устройства" и "Сценарии".
        *   Использует `BottomNavigationBar` для переключения между вкладками.
        *   Отображает список устройств или список сценариев в зависимости от выбранной вкладки.
        *   Содержит `FloatingActionButton` для добавления нового устройства или создания нового сценария.
        *   Реализует `RefreshIndicator` для обновления списка устройств.
    *   **`add_device_screen.dart` (`AddDeviceScreen`)**:
        *   Экран для добавления новых устройств.
        *   Позволяет добавить устройство вручную по IP-адресу или запустить автоматический поиск устройств в сети.
        *   Включает функцию проверки соединения с указанным IP.
    *   **`edit_scenario_screen.dart` (`EditScenarioScreen`)**:
        *   Экран для создания и редактирования сценариев.
        *   Позволяет задать имя, описание, цвет и иконку сценария.
        *   Позволяет добавлять, редактировать и удалять действия в сценарии.
        *   Для каждого действия можно выбрать устройство, реле, операцию (включить/выключить) и задержку.
    *   **`scenario_list_screen.dart` (`ScenarioListScreen`)**:
        *   Отображает список созданных сценариев.
        *   Для каждого сценария доступны кнопки для запуска, редактирования, удаления и переключения активности.
    *   **`scenario_log_screen.dart` (`ScenarioLogScreen`)**:
        *   Отображает детальный лог выполнения выбранного сценария.
        *   Каждая запись лога имеет иконку и цвет в зависимости от типа сообщения (начало, успех, ошибка, задержка и т.д.).

*   **`widgets/`**: Переиспользуемые UI-компоненты.
    *   **`device_tile.dart` (`DeviceTile`)**:
        *   Виджет для отображения информации об одном устройстве в списке.
        *   Показывает имя устройства, IP, статус реле, уровень сигнала.
        *   Предоставляет элементы управления для каждого реле (переключение, переименование) и для самого устройства (обновить, удалить).
    *   **`scenario_tile.dart` (`ScenarioTile`)**:
        *   Виджет для отображения информации об одном сценарии в списке.
        *   Показывает имя, описание, иконку, цвет, статус активности, количество действий и время последнего запуска.
        *   Предоставляет кнопки для запуска, редактирования, удаления и переключения активности сценария.
    *   **`scenario_action_card.dart` (`ScenarioActionCard`)**:
        *   Виджет для отображения одного действия в списке действий сценария на экране `EditScenarioScreen`.
        *   Показывает имя устройства, имя реле, выполняемое действие (ВКЛ/ВЫКЛ), задержку (если есть) и статус активности действия.
        *   Предоставляет кнопки для редактирования, удаления и переключения активности действия.

### 3.2. Прошивка ESP8266 (`esp8266_relay_controller/esp8266_relay_controller.ino`)

*   **Основные библиотеки:** `ESP8266WiFi`, `ESP8266WebServer`, `WiFiManager`, `U8g2lib` (для OLED-дисплея), `ESP8266mDNS`, `ArduinoJson`, `EEPROM`.
*   **Функциональность:**
    *   **WiFi-соединение:** Использует `WiFiManager` для упрощенной настройки Wi-Fi. При первом запуске или потере настроек создает точку доступа "SmartRelay" для конфигурации.
    *   **Веб-сервер:** Предоставляет HTTP API для управления реле и получения статуса.
        *   `GET /`: HTML-страница для ручного управления реле и просмотра статуса.
        *   `GET /toggle?relay=<id>`: Переключение состояния указанного реле.
        *   `GET /status`: Возвращает JSON с текущим состоянием всех реле, IP-адресом, RSSI и информацией о поддержке/статусе сценариев.
        *   `POST /set-name`: Установка нового имени для реле (сохраняется в EEPROM).
        *   `GET /ping`: Простой эндпоинт для проверки доступности устройства.
        *   `POST /run-scenario`: Принимает JSON с массивом действий для выполнения сценария непосредственно на устройстве.
    *   **mDNS:** Регистрирует устройство в локальной сети под именем `_http._tcp.local` с именем хоста "SmartRelay" для обнаружения.
    *   **Управление реле:** Контролирует до 4 реле. Состояния реле сохраняются в EEPROM.
    *   **Имена реле:** Пользовательские имена для реле сохраняются в EEPROM и используются в JSON-ответах и на OLED-дисплее. Поддерживается UTF-8 (кириллица).
    *   **OLED-дисплей (SH1106, 128x64):**
        *   Отображает информацию о сети (SSID, IP, RSSI, имя устройства).
        *   Отображает статус каждого реле (имя и состояние ВКЛ/ВЫКЛ).
        *   Отображает информацию о выполнении сценария (прогресс).
        *   Автоматическое переключение страниц информации.
        *   Спящий режим для дисплея после периода неактивности.
    *   **Кнопка сброса:** Длительное нажатие на кнопку (подключенную к D3) сбрасывает настройки Wi-Fi.
    *   **Выполнение сценариев на устройстве:** При получении команды `/run-scenario`, ESP8266 последовательно выполняет указанные действия с учетом задержек.

## 4. Зависимости (Flutter - `pubspec.yaml`)

*   `flutter`: SDK для Flutter.
*   `cupertino_icons`: Иконки в стиле iOS.
*   `http`: Для выполнения HTTP-запросов к ESP8266.
*   `multicast_dns`: Для обнаружения устройств в сети по mDNS.
*   `intl`: Для форматирования дат и времени.
*   `provider`: Для управления состоянием приложения.
*   `shared_preferences`: Для сохранения настроек и списка устройств локально.
*   `flutter_spinkit`: Коллекция индикаторов загрузки.
*   `uuid`: Для генерации уникальных идентификаторов для сценариев и действий.
*   `flutter_launcher_icons`: Для генерации иконок приложения.
*   `flutter_lints`: Набор правил для статического анализа кода.

## 5. Пользовательский интерфейс

Приложение имеет простой и интуитивно понятный интерфейс:

*   **Главный экран:** Разделен на две вкладки – "Устройства" и "Сценарии".
*   **Вкладка "Устройства":** Отображает список добавленных релейных модулей. Каждое устройство представлено карточкой (`DeviceTile`), на которой можно видеть его имя, IP, статус реле, а также управлять каждым реле индивидуально. Есть возможность обновить статус всех устройств или удалить устройство.
*   **Вкладка "Сценарии":** Отображает список созданных сценариев. Каждый сценарий представлен карточкой (`ScenarioTile`), на которой можно видеть его имя, описание, иконку, цвет, статус активности и кнопки для запуска, редактирования и удаления.
*   **Добавление устройств:** Отдельный экран (`AddDeviceScreen`) позволяет либо ввести IP-адрес устройства вручную, либо запустить автоматический поиск в сети.
*   **Создание/редактирование сценария:** Отдельный экран (`EditScenarioScreen`) предоставляет форму для настройки имени, описания, цвета, иконки сценария и добавления/редактирования действий. Каждое действие настраивается выбором устройства, реле, операции и задержки.
*   **Лог выполнения сценария:** Экран (`ScenarioLogScreen`) показывает подробный отчет о последнем выполнении сценария.

## 6. Сборка и запуск

*   **Прошивка ESP8266:** Код из `esp8266_relay_controller/esp8266_relay_controller.ino` компилируется и загружается на ESP8266 с помощью Arduino IDE или PlatformIO.
*   **Flutter-приложение:** Собирается и запускается на Android/iOS устройствах стандартными командами Flutter (`flutter run`).

Этот проект представляет собой комплексное решение для управления умными реле, сочетая в себе мобильное приложение на Flutter и прошивку для микроконтроллера ESP8266.
